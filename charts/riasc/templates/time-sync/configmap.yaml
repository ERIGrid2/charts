{{- if .Values.time_sync.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "riasc.fullname" . }}-time-sync
  namespace: riasc-system
  labels:
    {{- include "riasc.labels" . | nindent 4 }}
data:

  chrony.conf: |
    # This directive specify the location of the file containing ID/key pairs for
    # NTP authentication.
    keyfile /etc/chrony/chrony.keys
    
    # This directive specify the file into which chronyd will store the rate
    # information.
    driftfile /var/lib/chrony/chrony.drift
    
    # Log files location.
    logdir /var/log/chrony
    
    # Any NTP clients are allowed to access the NTP server.
    allow
    
    # Allows to appear synchronized to NTP clients, even when it is not.
    local orphan
    
    # The lock_all directive will lock chronyd into RAM so that it will
    # never be paged out. This mode is only supported on Linux. This
    # directive uses the Linux mlockall() system call to prevent chronyd
    # from ever being swapped out. This should result in lower and more
    # consistent latency.
    lock_all
    
    # Stop bad estimates upsetting machine clock.
    maxupdateskew 100.0
    
    # This directive tells 'chronyd' to parse the 'adjtime' file to find out if the
    # real-time clock keeps local time or UTC. It overrides the 'rtconutc' directive.
    hwclockfile /etc/adjtime
    
    # This directive enables kernel synchronization (every 11 minutes) of the
    # real-time clock. Note that it canâ€™t be used along with the 'rtcfile' directive.
    rtcsync
    
    # Step the system clock instead of slewing it if the adjustment is larger than
    # one second, but only in the first three clock updates.
    #makestep 1 3
    makestep 0.2 -1
    
    # This directive enables hardware time-stamping of NTP packets sent to and
    # received from the specified network interface.
    hwtimestamp *
    
    # https://chrony.tuxfamily.org/documentation.html
    # https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html#_feeding_chrony_from_gpsd
    # gspd is looking for
    # /var/run/chrony.pps0.sock
    
    # PPS: /dev/pps0: Kernel-mode PPS ref-clock for the precise seconds
    refclock  PPS /dev/pps0                   refid PPS0  precision 1e-7  poll 3  trust  noselect  lock PSM0
    
    # SHM(0), gpsd: NMEA data from shared memory provided by gpsd
    refclock  SHM 0                           refid GPS0  precision 1e-1  poll 3  trust  noselect  offset 0.0
    
    # SHM(1), gpsd: PPS0 data from shared memory provided by gpsd
    refclock  SHM 1                           refid PSM0  precision 1e-7  poll 3  trust  prefer
    
    # SOCK, gpsd: PPS0 data from socket provided by gpsd
    refclock  SOCK /var/run/chrony.pps0.sock  refid PST0  precision 1e-7  poll 3  trust  noselect
    
    # NTP Servers
    #pool  2.debian.pool.ntp.org  iburst  minpoll 4  maxpoll 4
    pool   europe.pool.ntp.org    iburst  minpoll 4  maxpoll 4
    #pool  de.pool.ntp.org        iburst  minpoll 4  maxpoll 4

{{- range .Values.time_sync.ntp.servers }}
    server  {{ . }}  iburst  minpoll 4  maxpoll 4
{{- end }}

    # Some Stratum1 Servers
    # https://www.meinbergglobal.com/english/glossary/public-time-server.htm
    # http://support.ntp.org/bin/view/Servers/StratumOneTimeServers
    
    ## Physikalisch-Technische Bundesanstalt (PTB), Braunschweig, Germany
    server  ptbtime1.ptb.de  iburst  minpoll 4  maxpoll 4
    server  ptbtime2.ptb.de  iburst  minpoll 4  maxpoll 4
    server  ptbtime3.ptb.de  iburst  minpoll 4  maxpoll 4
    
    ## Royal Observatory of Belgium
    server  ntp1.oma.be  iburst  minpoll 4  maxpoll 4
    server  ntp2.oma.be  iburst  minpoll 4  maxpoll 4
    
    # The log directive indicates that certain information is to be logged.
    # The log files are written to the directory specified by the logdir
    # directive. A banner is periodically written to the files to indicate
    # the meanings of the columns.
    log rawmeasurements measurements statistics tracking refclocks tempcomp
    
    # The logbanner directive specifies after how many entries in the log file
    # should be the banner written.
    # logbanner 32: the default
    # logbanner -1: for one every restart only
    # logbanner  0: to disable it entirely
    logbanner 0
    
    # This directive sets the threshold for the adjustment of the system
    # clock that will generate a syslog message. Clock errors detected via
    # NTP packets, reference clocks, or timestamps entered via the settime
    # command of chronyc are logged.
    logchange 0.1
    
    # The tempcomp directive can be used to compensate for the changes
    # in the temperature and improve the stability and accuracy of the clock.
    # (/sys/class/thermal/thermal_zone0/temp = Raspberry Pi CPU temp)
    tempcomp /sys/class/thermal/thermal_zone0/temp  8  /etc/chrony/stratum1/chrony.tempcomp
{{- end }}
